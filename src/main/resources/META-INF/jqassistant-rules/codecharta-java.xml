<jqassistant-rules xmlns="http://schema.jqassistant.org/rule/v2.2"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://schema.jqassistant.org/rule/v2.2 https://jqassistant.github.io/jqassistant/current/schema/jqassistant-rule-v2.2.xsd">

    <concept id="codecharta-java:TypeMetrics">
        <providesConcept refId="codecharta:Metrics"/>
        <requiresConcept refId="java:GeneratedType"/>
        <description>Provides LoC, CC, FanIn and FanOut of Java Types as :Metrics.</description>
        <cypher><![CDATA[
            MATCH
              (:Artifact)-[:CONTAINS]->(type:Java:Type)
            WHERE NOT
              type:Generated
            OPTIONAL MATCH
              (type)-[:DECLARES]->(method:Method)
            WITH
              type, sum(method.effectiveLineCount) AS loc, sum(method.cyclomaticComplexity) AS cc
            OPTIONAL MATCH
              (dependent:Type)-[:DEPENDS_ON]->(type)
            WITH
              type, loc, cc, count(dependent) AS fanIn
            OPTIONAL MATCH
              (type)-[:DEPENDS_ON]->(dependency:Type)
            WITH
              type, loc, cc, fanIn, count(dependency) AS fanOut
            MERGE
              (type)-[:HAS_METRICS]->(metrics:CodeCharta:Metrics)
            SET
              metrics = {loc: loc, cc: cc, fanIn: fanIn, fanOut: fanOut}
            RETURN
              count(type) AS Elements
            ]]></cypher>
        <verify>
            <aggregation/>
        </verify>
    </concept>

    <concept id="codecharta-java:Report">
        <requiresConcept refId="codecharta:Metrics"/>
        <requiresConcept refId="java:GeneratedType"/>
        <description>Creates a CodeCharta report for Java types.</description>
        <cypher><![CDATA[
            MATCH
              (:Artifact)-[:CONTAINS]->(element:Type|Package)
            WHERE NOT
              element:Generated
            OPTIONAL MATCH
              (parent:Package)-[:CONTAINS]->(element)
            OPTIONAL MATCH
              (element:Type)-[:HAS_METRICS]->(metrics:CodeCharta:Metrics)
            RETURN
              element AS Element, element.name AS ElementLabel, parent AS Parent, metrics AS Metrics
            ]]></cypher>
        <report type="codecharta"/>
    </concept>

</jqassistant-rules>
